// Generated by CoffeeScript 1.3.3
(function() {

  window.plugins.efficiency = {
    efficiencyDIV: null,
    emit: function(div, item) {
      wiki.log('efficiency', div, item);
      div.addClass('data');
      $('<p />').addClass('readout').appendTo(div).text("0%");
      this.efficiencyDIV = div;
      return $('<p />').html(wiki.resolveLinks(item.text || 'efficiency')).appendTo(div);
    },
    bind: function(div, item) {
      var calculate, calculatePercentage, getImageData, lastThumb, locate, setEfficiencyReadoutValue,
        _this = this;
      lastThumb = null;
      div.find('p:first').dblclick(function(e) {
        return wiki.dialog("JSON for " + item.text, $('<pre/>').text("something good"));
      });
      div.find('p:last').dblclick(function() {
        return wiki.textEditor(div, item);
      });
      locate = function() {
        var idx, who;
        idx = $('.item').index(div);
        who = $(".item:lt(" + idx + ")").filter('.image').toArray().reverse();
        return who.last();
      };
      calculate = function(div) {
        var data, value;
        data = getImageData(div);
        value = calculatePercentage(data);
        return setEfficiencyReadoutValue(value);
      };
      getImageData = function(div) {
        var c, d, imageData, img, src;
        src = $(div).find('img').get(0);
        c = $('<canvas id="myCanvas" width="200" height="100" style="border:1px solid #c3c3c3;">');
        d = c.get(0).getContext("2d");
        img = new Image();
        img.src = src;
        d.drawImage(src, 0, 0);
        imageData = d.getImageData(0, 0, 200, 100);
        return imageData.data;
      };
      calculatePercentage = function(data) {
        return 47;
      };
      setEfficiencyReadoutValue = function(value) {
        if (_this.efficiencyDIV) {
          return $(_this.efficiencyDIV)[0].innerHTML = '<p class="readout">' + value + '%</p><p>Pattern Efficiency from Photographic Statistics</p>';
        }
      };
      return calculate(locate());
    }
  };

}).call(this);
